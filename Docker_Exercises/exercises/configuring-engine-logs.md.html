<html>
<head>
    <title>configuring-engine-logs.md</title>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u' crossorigin='anonymous'>
    <link href="../app.css" rel="stylesheet" >
</head>
<body>
    <nav class="navbar navbar-default">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><img class="logo" src="https://www.docker.com/sites/all/themes/docker/assets/images/brand-full.svg" alt="Docker" title="Docker"/></a>
        </div>
    </div><!-- /.container-fluid -->
    </nav>
    <div class="container">
    <div class="row">
        <div class="content">
            <h1 id="configuring-engine-logs">Configuring Engine Logs</h1>
<p>By the end of this exercise, you should be able to:</p>
<ul>
<li>Configure Docker Engine&#39;s logging driver</li>
<li>Interpret the output of logs generated by the <code>json-file</code> and <code>journald</code> log drivers</li>
<li>Configure log compression and rotation</li>
</ul>
<h2 id="setting-the-logging-driver">Setting the Logging Driver</h2>
<p>Docker offers a number of different logging drivers for recording the STDOUT and STDERR of PID 1 processes in a container; below we&#39;ll explore the defaults which correspond to the <code>json-file</code> driver, and the <code>journald</code> driver.</p>
<ol>
<li><p>Run a simple container with the default logging configuration, and inspect its logs:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ docker container run -d centos:7 ping 8.8.8.8
[centos@ucp-node-0 ~]$ docker container logs &lt;container ID&gt;

PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=0.631 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=0.652 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=0.646 ms
</code></pre>
</li>
<li><p>Examine these same logs directly on disk; note <code>&lt;container ID&gt;</code> here is the full, untruncated container ID returned when you created the container above, or findable via <code>docker container ls --no-trunc</code>:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ sudo head -5 \
    /var/lib/docker/containers/&lt;container ID&gt;/&lt;container ID&gt;-json.log

{&quot;log&quot;:&quot;PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,
    &quot;time&quot;:&quot;2018-09-17T17:29:35.263052015Z&quot;}
{&quot;log&quot;:&quot;64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=0.631 ms\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,
    &quot;time&quot;:&quot;2018-09-17T17:29:35.263086694Z&quot;}
{&quot;log&quot;:&quot;64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=0.652 ms\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,
    &quot;time&quot;:&quot;2018-09-17T17:29:36.263133476Z&quot;}
{&quot;log&quot;:&quot;64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=0.646 ms\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,
    &quot;time&quot;:&quot;2018-09-17T17:29:37.263125448Z&quot;}
{&quot;log&quot;:&quot;64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=0.577 ms\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,
    &quot;time&quot;:&quot;2018-09-17T17:29:38.263049365Z&quot;}
</code></pre>
<p>By default, logs are recorded as per the <code>json-file</code> driver format.</p>
</li>
<li><p>Configure your logging driver to send logs to the system journal by updating <code>/etc/docker/daemon.json</code> on <code>ucp-node-0</code> to look like this (note you&#39;ll need to open this file with <code>sudo</code> permissions in order to edit it):</p>
<pre><code class="lang-json">{
    &quot;storage-driver&quot;: &quot;overlay2&quot;,
    &quot;log-driver&quot;: &quot;journald&quot;
}
</code></pre>
</li>
<li><p>Restart Docker so the new logging configuration takes effect:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ sudo service docker restart
</code></pre>
</li>
<li><p>Run another container, just like the one you ran above, but this time name it <code>demo</code>:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ docker container run -d --name demo centos:7 ping 8.8.8.8
</code></pre>
</li>
<li><p>Inspect the system journal for messages from the <code>demo</code> container:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ journalctl CONTAINER_NAME=demo
</code></pre>
<p>In this way, container logs can be sent to the system journal for ingestion by a centralized logging framework along with the rest of the journal messages.</p>
</li>
</ol>
<h2 id="configuring-log-compression-and-rotation">Configuring Log Compression and Rotation</h2>
<p>By default, container logfiles can grow unbounded until all host disk is consumed. Many file-based logging drivers like <code>json-file</code> support automatic log rotation and compression.</p>
<ol>
<li><p>Configure the Docker engine on <code>ucp-node-0</code> to create a json file of logs, swapping to a new file every 5 kb, preserving a maximum of 3 files, by changing your <code>/etc/docker/daemon.json</code> to look like this:</p>
<pre><code class="lang-json">{
    &quot;storage-driver&quot;: &quot;overlay2&quot;,
    &quot;log-driver&quot;: &quot;json-file&quot;,
    &quot;log-opts&quot;: {
        &quot;max-size&quot;: &quot;5k&quot;,
        &quot;max-file&quot;: &quot;3&quot;,
        &quot;compress&quot;: &quot;true&quot;
    }
}
</code></pre>
</li>
<li><p>Restart Docker so the new logging configuration takes effect:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ sudo service docker restart
</code></pre>
</li>
<li><p>Start another container generating logs:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ docker container run -d centos:7 ping 8.8.8.8
</code></pre>
</li>
<li><p>Find the container&#39;s log files under <code>/var/lib/docker/containers</code>:</p>
<pre><code class="lang-bash">[centos@ucp-node-0 ~]$ sudo ls -lsh /var/lib/docker/containers/&lt;container ID&gt;

&lt;container ID&gt;-json.log
&lt;container ID&gt;-json.log.1.gz
&lt;container ID&gt;-json.log.2.gz
...
</code></pre>
<p>At first you&#39;ll probably only see the <code>-json.log</code> file; the <code>.1.gz</code> and <code>.2.gz</code> will appear as log files get rotated out.</p>
</li>
<li><p>Keep listing the above directory every few seconds; you should see the original log file get rotated to <code>&lt;container ID&gt;-json.log.1.gz</code> once it reaches about 5 kb in size. Also, once it gets rotated out to <code>.1.gz</code>, it will be automatically compressed. </p>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>In this exercise, we reconfigured the Docker Engine&#39;s default logging options, and rotated out and compressed logfiles once they reached a certain size. An important aspect of cluster design is allocating and managing disk space for logs; while we can&#39;t provision an unlimited amount of disk on each of our nodes for logs, the more logs we&#39;re able to keep, the further back in history we can look when troubleshooting our deployments.</p>

        </div>        
    </div>
    <div class="row">
        <ul class="mt-article-pagination" style="display:block;">
        </ul>
    </div>
</div>
    <div class="footer"></div>
</body>